<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è¥¿å§çš„å°åŠ©ç†</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: #F5F5F7; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* å½•éŸ³æ³¢çº¹ */
        .wave-container {
            display: flex; justify-content: center; align-items: center; height: 40px; gap: 4px;
        }
        .wave-bar {
            width: 4px; height: 10px; background-color: #3B82F6; border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }
        .wave-bar:nth-child(1) { animation-delay: 0.0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave {
            0%, 100% { height: 10px; opacity: 0.5; }
            50% { height: 25px; opacity: 1; }
        }

        .calendar-cell { min-height: 85px; border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        .calendar-cell:nth-child(7n) { border-right: none; }
        .event-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        input, textarea { -webkit-appearance: none; border-radius: 0.5rem; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-white">

    <!-- é¡¶éƒ¨æ  -->
    <header class="bg-[#F5F5F7] px-4 pt-12 pb-3 flex justify-between items-end border-b border-gray-200 sticky top-0 z-20">
        <div>
            <div class="text-xs text-gray-500 font-medium mb-0.5" id="headerDate">...</div>
            <div class="flex items-center">
                <h1 class="text-2xl font-bold text-black tracking-tight">
                    è¥¿å§çš„å°åŠ©ç†
                </h1>
                <!-- å¯¼å‡ºæŒ‰é’® -->
                <button onclick="openExportModal()" class="ml-3 w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-500 active:scale-95 transition">
                    <i class="fas fa-file-export text-xs"></i>
                </button>
            </div>
        </div>
        <div class="flex bg-white rounded-lg p-1 shadow-sm">
            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-blue-600"><i class="fas fa-chevron-left"></i></button>
            <span class="w-16 flex items-center justify-center font-bold text-sm" id="currentMonthLabel">...</span>
            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-blue-600"><i class="fas fa-chevron-right"></i></button>
        </div>
    </header>

    <!-- æ˜ŸæœŸå¤´ -->
    <div class="grid grid-cols-7 bg-[#F5F5F7] border-b border-gray-200 py-1">
        <div class="text-center text-xs text-gray-400">æ—¥</div>
        <div class="text-center text-xs text-gray-400">ä¸€</div>
        <div class="text-center text-xs text-gray-400">äºŒ</div>
        <div class="text-center text-xs text-gray-400">ä¸‰</div>
        <div class="text-center text-xs text-gray-400">å››</div>
        <div class="text-center text-xs text-gray-400">äº”</div>
        <div class="text-center text-xs text-gray-400">å…­</div>
    </div>

    <!-- æ—¥å†ä¸»ä½“ -->
    <div class="flex-1 overflow-y-auto bg-white relative" id="calendarContainer">
        <div class="grid grid-cols-7 border-l border-gray-100" id="calendarGrid"></div>
        <div class="h-32"></div>
    </div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div class="fixed bottom-8 left-0 w-full flex flex-col items-center justify-center z-40 safe-area-bottom pointer-events-none">
        <div class="relative group pointer-events-auto">
            <button id="micBtn" class="w-16 h-16 bg-blue-600 rounded-full text-white shadow-xl flex items-center justify-center text-2xl transition-transform active:scale-95">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
        <p class="text-[10px] text-gray-400 mt-2 font-medium">ç‚¹å‡»å½•éŸ³</p>
    </div>

    <!-- è¯¦æƒ…åˆ—è¡¨å¼¹çª— -->
    <div id="detailModal" class="hidden fixed inset-0 z-[9000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl relative flex flex-col max-h-[60vh]">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <div>
                    <h3 class="text-lg font-bold text-gray-800" id="detailDateTitle">...</h3>
                    <p class="text-xs text-gray-500" id="detailWeekday">...</p>
                </div>
                <button onclick="closeDetailModal()" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- åˆ—è¡¨åŒºåŸŸ -->
            <div id="detailList" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-1">
                <!-- å†…å®¹ç”± JS ç”Ÿæˆ -->
            </div>

            <!-- åº•éƒ¨æ“ä½œ -->
            <button onclick="openManualAddFromDetail()" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm hover:bg-blue-100 transition">
                <i class="fas fa-plus mr-1"></i> æ‰‹åŠ¨æ·»åŠ ä¸€æ¡
            </button>
        </div>
    </div>

    <!-- å½•éŸ³/ç¼–è¾‘å¼¹çª— -->
    <div id="editModal" class="hidden fixed inset-0 z-[10000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transition-all relative">
            
            <!-- å½•éŸ³æ—¶çš„è¦†ç›–å±‚ -->
            <div id="listeningOverlay" class="hidden absolute inset-0 bg-white/95 z-10 flex-col items-center justify-center rounded-2xl">
                <div class="wave-container mb-4">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">æ­£åœ¨è†å¬...</h3>
                <p id="liveText" class="text-sm text-gray-500 px-4 text-center min-h-[20px]">è¯·è¯´è¯...</p>
                <button onclick="stopMic()" class="mt-6 px-6 py-2 bg-red-100 text-red-600 rounded-full font-bold text-xs">
                    åœæ­¢å¹¶ç”Ÿæˆ
                </button>
            </div>

            <!-- ç¼–è¾‘ç•Œé¢ -->
            <h3 class="text-lg font-bold mb-4 text-center text-gray-800">ğŸ“… è®°å½•æ—¥ç¨‹</h3>
            
            <textarea id="editContent" rows="3" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl mb-3 text-base focus:ring-2 focus:ring-blue-500 outline-none" placeholder="å†…å®¹ä¼šå‡ºç°åœ¨è¿™é‡Œ..."></textarea>
            
            <div class="flex gap-2 mb-5">
                <div class="flex-1">
                    <label class="text-xs text-gray-400 font-bold ml-1">æ—¥æœŸ</label>
                    <input type="date" id="editDate" class="w-full border border-gray-200 p-2.5 rounded-xl bg-gray-50 text-sm">
                </div>
                <div class="w-28">
                    <label class="text-xs text-gray-400 font-bold ml-1">æ—¶é—´</label>
                    <input type="time" id="editTime" class="w-full border border-gray-200 p-2.5 rounded-xl bg-gray-50 text-sm">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold active:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="saveEvent()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºé€‰é¡¹å¼¹çª— (æ–°å¢) -->
    <div id="exportModal" class="hidden fixed inset-0 z-[11000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-file-csv text-green-600 mr-2"></i> å¯¼å‡ºæ•°æ®
            </h3>
            
            <div class="space-y-3 mb-6">
                <label class="flex items-center p-3 border border-gray-200 rounded-xl bg-gray-50 cursor-pointer active:bg-blue-50 transition">
                    <input type="radio" name="exportRange" value="week" class="text-blue-600 focus:ring-blue-500 w-4 h-4">
                    <span class="ml-3 text-sm font-medium text-gray-700">æœ¬å‘¨æ•°æ®</span>
                </label>
                <label class="flex items-center p-3 border border-gray-200 rounded-xl bg-gray-50 cursor-pointer active:bg-blue-50 transition">
                    <input type="radio" name="exportRange" value="month" checked class="text-blue-600 focus:ring-blue-500 w-4 h-4">
                    <span class="ml-3 text-sm font-medium text-gray-700">å½“å‰è§†å›¾æœˆä»½</span>
                </label>
                <label class="flex items-center p-3 border border-gray-200 rounded-xl bg-gray-50 cursor-pointer active:bg-blue-50 transition">
                    <input type="radio" name="exportRange" value="year" class="text-blue-600 focus:ring-blue-500 w-4 h-4">
                    <span class="ml-3 text-sm font-medium text-gray-700">ä»Šå¹´å…¨éƒ¨</span>
                </label>
                <label class="flex items-center p-3 border border-gray-200 rounded-xl bg-gray-50 cursor-pointer active:bg-blue-50 transition">
                    <input type="radio" name="exportRange" value="all" class="text-blue-600 focus:ring-blue-500 w-4 h-4">
                    <span class="ml-3 text-sm font-medium text-gray-700">æ‰€æœ‰å†å²è®°å½•</span>
                </label>
            </div>

            <div class="flex gap-3">
                <button onclick="closeExportModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold active:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="executeExport()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-green-500/30 active:scale-95 transition">
                    å¯¼å‡º Excel
                </button>
            </div>
        </div>
    </div>

    <script>
        dayjs.locale('zh-cn');
        
        var state = {
            currentDate: dayjs(),
            selectedDateStr: null, 
            events: JSON.parse(localStorage.getItem('xi_assistant_events')) || [],
            isRecording: false
        };
        
        var recognition = null;
        var SpeechClass = window.SpeechRecognition || window.webkitSpeechRecognition;

        window.onload = function() {
            renderHeader();
            renderCalendar();
            document.getElementById('micBtn').addEventListener('click', startRecordingFlow);
        };

        // --- æ ¸å¿ƒ 1ï¼šå½•éŸ³æµç¨‹ ---
        function startRecordingFlow() {
            if(!SpeechClass) return alert("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥");

            // æ¸…ç©ºæ—§æ•°æ®
            document.getElementById('editContent').value = '';
            document.getElementById('editDate').value = dayjs().format('YYYY-MM-DD');
            document.getElementById('editTime').value = dayjs().format('HH:mm');

            var modal = document.getElementById('editModal');
            var overlay = document.getElementById('listeningOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            document.getElementById('liveText').innerText = "ç­‰å¾…å£°éŸ³...";
            
            if(recognition) {
                try { recognition.abort(); } catch(e){}
                recognition = null;
            }

            try {
                recognition = new SpeechClass();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onstart = function() {
                    state.isRecording = true;
                    document.getElementById('liveText').innerText = "æ­£åœ¨å¬...";
                };

                recognition.onresult = function(event) {
                    var text = event.results[0][0].transcript;
                    document.getElementById('liveText').innerText = text;
                    if(event.results[0].isFinal) {
                        finishRecording(text);
                    }
                };

                recognition.onerror = function(e) {
                    if(e.error !== 'no-speech') {
                        stopMic(); 
                    }
                };

                recognition.onend = function() {
                    if(state.isRecording) stopMic();
                };

                recognition.start();

            } catch(e) {
                alert("å¯åŠ¨å¤±è´¥: " + e.message);
                stopMic();
            }
        }

        function stopMic() {
            state.isRecording = false;
            if(recognition) {
                try { recognition.stop(); } catch(e){}
            }
            var overlay = document.getElementById('listeningOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        function finishRecording(text) {
            stopMic();
            processVoice(text);
        }

        // --- æ ¸å¿ƒ 2ï¼šè¯¦æƒ…é¡µ & åˆ é™¤ ---
        function openDetailModal(dateStr) {
            state.selectedDateStr = dateStr;
            var dateObj = dayjs(dateStr);
            
            document.getElementById('detailDateTitle').innerText = dateObj.format('MæœˆDæ—¥');
            document.getElementById('detailWeekday').innerText = dateObj.format('dddd');
            
            var listEl = document.getElementById('detailList');
            listEl.innerHTML = '';

            var dayEvents = state.events.filter(e => e.date === dateStr);
            
            if(dayEvents.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-mug-hot text-3xl mb-2 opacity-50"></i>
                        <p class="text-xs">ä»Šå¤©æš‚æ— å®‰æ’</p>
                    </div>
                `;
            } else {
                dayEvents.forEach(e => {
                    var div = document.createElement('div');
                    div.className = "flex items-start p-3 bg-gray-50 rounded-xl border border-gray-100 group";
                    div.innerHTML = `
                        <div class="w-12 text-xs font-bold text-gray-400 pt-0.5">${e.time || '--:--'}</div>
                        <div class="flex-1 text-sm font-medium text-gray-800 break-all leading-snug">${e.content}</div>
                        <button onclick="deleteEvent('${e.id}')" class="text-gray-300 hover:text-red-500 pl-3 active:scale-95 transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    listEl.appendChild(div);
                });
            }

            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function openManualAddFromDetail() {
            closeDetailModal();
            openEditModal(state.selectedDateStr, '', dayjs().format('HH:mm'));
        }

        function deleteEvent(id) {
            if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡æ—¥ç¨‹å—ï¼Ÿ")) {
                state.events = state.events.filter(e => e.id !== id);
                localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
                renderCalendar();
                openDetailModal(state.selectedDateStr);
            }
        }

        // --- æ ¸å¿ƒ 3ï¼šå¯¼å‡ºåŠŸèƒ½ ---
        function openExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function executeExport() {
            var range = document.querySelector('input[name="exportRange"]:checked').value;
            var filtered = [];
            var now = dayjs();
            
            // æ’åº
            var sortedEvents = [].concat(state.events).sort(function(a, b) {
                return (a.date + a.time).localeCompare(b.date + b.time);
            });

            if (range === 'all') {
                filtered = sortedEvents;
            } else if (range === 'month') {
                // å¯¼å‡ºå½“å‰è§†å›¾æ‰€åœ¨çš„æœˆä»½
                filtered = sortedEvents.filter(function(e) {
                    return dayjs(e.date).isSame(state.currentDate, 'month');
                });
            } else if (range === 'year') {
                filtered = sortedEvents.filter(function(e) {
                    return dayjs(e.date).isSame(now, 'year');
                });
            } else if (range === 'week') {
                filtered = sortedEvents.filter(function(e) {
                    return dayjs(e.date).isSame(now, 'week');
                });
            }

            if (filtered.length === 0) {
                alert("è¯¥æ—¶æ®µæ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
                return;
            }

            // ç”Ÿæˆ CSV (åŠ  BOM å¤´ \uFEFF ä»¥æ”¯æŒ Excel ä¸­æ–‡)
            var csvContent = "æ—¥æœŸ,æ—¶é—´,å†…å®¹\n";
            filtered.forEach(function(e) {
                var cleanContent = e.content.replace(/"/g, '""'); // å¤„ç†åŒå¼•å·
                csvContent += e.date + "," + e.time + ",\"" + cleanContent + "\"\n";
            });

            var blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement("a");
            link.setAttribute("href", url);
            var filename = "æ—¥ç¨‹å¯¼å‡º_" + dayjs().format('YYYYMMDD_HHmm') + ".csv";
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            closeExportModal();
        }

        // --- è¾…åŠ©é€»è¾‘ ---
        function processVoice(text) {
            var date = dayjs();
            var content = text;
            var dateChanged = false;

            if(text.includes('æ˜å¤©')) { date = date.add(1, 'day'); content = content.replace(/æ˜å¤©/g, ''); dateChanged = true; }
            else if(text.includes('åå¤©')) { date = date.add(2, 'day'); content = content.replace(/åå¤©/g, ''); dateChanged = true; }
            
            var weekMap = { 'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'æ—¥': 0, 'å¤©': 0 };
            var weekMatch = content.match(/(ä¸‹|æœ¬)?(?:ä¸ª)?(?:å‘¨|æ˜ŸæœŸ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/);

            if (weekMatch && !dateChanged) {
                var prefix = weekMatch[1]; 
                var dayChar = weekMatch[2];
                var targetDay = weekMap[dayChar];

                if (prefix === 'ä¸‹') {
                    date = date.add(1, 'week').day(targetDay);
                } else {
                    var tempDate = dayjs().day(targetDay);
                    if (tempDate.isBefore(dayjs(), 'day')) {
                        date = tempDate.add(1, 'week');
                    } else {
                        date = tempDate;
                    }
                }
                content = content.replace(weekMatch[0], '');
                dateChanged = true;
            }

            var dateMatch = content.match(/(\d{1,2})æœˆ(\d{1,2})[å·æ—¥]?/);
            if (dateMatch) {
                var month = parseInt(dateMatch[1]) - 1;
                var day = parseInt(dateMatch[2]);
                date = date.month(month).date(day);
                if (date.isBefore(dayjs(), 'day')) date = date.add(1, 'year');
                content = content.replace(dateMatch[0], '');
            }
            
            var targetTime = dayjs().format('HH:mm');
            var timeMatch = content.match(/(ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š)?(\d{1,2})ç‚¹(\d{1,2})?/);
            if(timeMatch) {
                var h = parseInt(timeMatch[2]);
                if((timeMatch[1] === 'ä¸‹åˆ' || timeMatch[1] === 'æ™šä¸Š') && h < 12) h += 12;
                var m = timeMatch[3] ? parseInt(timeMatch[3]) : 0;
                targetTime = (h<10?'0'+h:h) + ':' + (m<10?'0'+m:m);
                content = content.replace(timeMatch[0], '').replace('åˆ†','');
            }
            
            document.getElementById('editDate').value = date.format('YYYY-MM-DD');
            document.getElementById('editContent').value = content.trim();
            document.getElementById('editTime').value = targetTime;
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            stopMic();
        }

        function openEditModal(date, content, time) {
            var modal = document.getElementById('editModal');
            var overlay = document.getElementById('listeningOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.add('hidden'); 
            overlay.classList.remove('flex');
            
            document.getElementById('editDate').value = date || dayjs().format('YYYY-MM-DD');
            document.getElementById('editContent').value = content || '';
            document.getElementById('editTime').value = time || dayjs().format('HH:mm');
        }

        function renderHeader() {
            document.getElementById('headerDate').innerText = dayjs().format('YYYYå¹´MæœˆDæ—¥ dddd');
            document.getElementById('currentMonthLabel').innerText = state.currentDate.format('Mæœˆ');
        }

        function renderCalendar() {
            var grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            var start = state.currentDate.startOf('month');
            var days = state.currentDate.daysInMonth();
            var offset = start.day();

            for(var i=0; i<offset; i++) grid.innerHTML += '<div class="calendar-cell bg-gray-50"></div>';

            for(var i=1; i<=days; i++) {
                var dateStr = state.currentDate.date(i).format('YYYY-MM-DD');
                var isToday = dateStr === dayjs().format('YYYY-MM-DD');
                var dayEvents = state.events.filter(e => e.date === dateStr);
                
                var cell = document.createElement('div');
                cell.className = 'calendar-cell p-1 relative ' + (isToday ? 'bg-blue-50' : 'bg-white');
                cell.innerHTML = '<div class="text-right text-xs font-bold mb-1 '+(isToday?'text-blue-600':'text-gray-700')+'">'+i+'</div>';
                
                dayEvents.forEach(e => {
                    var color = "bg-gray-100 text-gray-600";
                    if(e.content.includes("é£ç”µ")) color = "bg-cyan-100 text-cyan-800";
                    if(e.content.includes("å‚¨èƒ½")) color = "bg-green-100 text-green-800";
                    cell.innerHTML += '<div class="event-tag '+color+'">'+e.content+'</div>';
                });

                (function(d){ cell.onclick = function(){ openDetailModal(d); }; })(dateStr);
                
                grid.appendChild(cell);
            }
        }

        function changeMonth(n) {
            state.currentDate = state.currentDate.add(n, 'month');
            renderHeader();
            renderCalendar();
        }

        function saveEvent() {
            var content = document.getElementById('editContent').value;
            var date = document.getElementById('editDate').value;
            var time = document.getElementById('editTime').value;
            
            if(!content) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
            
            state.events.push({ id: Date.now().toString(), content: content, date: date, time: time });
            localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
            
            closeEditModal();
            renderCalendar();
            
            if(state.selectedDateStr === date) {
                openDetailModal(date);
            }
        }
    </script>
</body>
</html>