<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è¥¿å§çš„å°åŠ©ç†(æœ€ç»ˆç‰ˆ)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: #F5F5F7; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .mic-wave {
            position: absolute; width: 100%; height: 100%;
            border-radius: 50%; background-color: rgba(37, 99, 235, 0.3);
            opacity: 0; z-index: -1; transform: scale(0.8);
        }
        .mic-active .mic-wave { animation: ripple 1.5s infinite; background-color: rgba(239, 68, 68, 0.4); }
        @keyframes ripple { 0% { transform: scale(0.8); opacity: 0.6; } 100% { transform: scale(1.6); opacity: 0; } }

        .calendar-cell { min-height: 85px; border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        .calendar-cell:nth-child(7n) { border-right: none; }
        .event-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        input, textarea { -webkit-appearance: none; border-radius: 0.5rem; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-white">

    <!-- é¡¶éƒ¨æ  -->
    <header class="bg-[#F5F5F7] px-4 pt-12 pb-3 flex flex-col border-b border-gray-200 sticky top-0 z-20">
        <div class="flex justify-between items-end mb-2">
            <div>
                <div class="text-xs text-gray-500 font-medium mb-0.5" id="headerDate">...</div>
                <h1 class="text-2xl font-bold text-black tracking-tight flex items-center">
                    è¥¿å§çš„å°åŠ©ç† <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full ml-2">v3.3</span>
                </h1>
            </div>
            <div class="flex bg-white rounded-lg p-1 shadow-sm">
                <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-gray-600"><i class="fas fa-chevron-left"></i></button>
                <span class="w-16 flex items-center justify-center font-bold text-sm" id="currentMonthLabel">...</span>
                <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-gray-600"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <!-- æ‰‹åŠ¨é‡ç½®æŒ‰é’® (å¦‚æœå¡æ­»ç‚¹è¿™ä¸ª) -->
        <div class="flex gap-2">
            <button onclick="window.location.reload()" class="bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-xs font-bold flex-1">
                ğŸ”„ åˆ·æ–°é‡ç½®
            </button>
            <button onclick="forceTestModal()" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded text-xs font-bold flex-1">
                ğŸ›  æµ‹è¯•å¼¹çª—
            </button>
        </div>
    </header>

    <!-- æ˜ŸæœŸå¤´ -->
    <div class="grid grid-cols-7 bg-[#F5F5F7] border-b border-gray-200 py-1">
        <div class="text-center text-xs text-gray-400">æ—¥</div>
        <div class="text-center text-xs text-gray-400">ä¸€</div>
        <div class="text-center text-xs text-gray-400">äºŒ</div>
        <div class="text-center text-xs text-gray-400">ä¸‰</div>
        <div class="text-center text-xs text-gray-400">å››</div>
        <div class="text-center text-xs text-gray-400">äº”</div>
        <div class="text-center text-xs text-gray-400">å…­</div>
    </div>

    <!-- æ—¥å†ä¸»ä½“ -->
    <div class="flex-1 overflow-y-auto bg-white relative" id="calendarContainer">
        <div class="grid grid-cols-7 border-l border-gray-100" id="calendarGrid"></div>
        <div class="h-32"></div>
    </div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div class="fixed bottom-8 left-0 w-full flex flex-col items-center justify-center z-40 safe-area-bottom pointer-events-none">
        <div class="bg-black/80 backdrop-blur-md text-white px-4 py-2 rounded-full text-xs font-bold mb-3 transition-opacity opacity-0" id="statusTip">
            å‡†å¤‡å°±ç»ª
        </div>
        <div class="relative group pointer-events-auto">
            <div class="mic-wave"></div>
            <button id="micBtn" class="w-16 h-16 bg-blue-600 rounded-full text-white shadow-xl flex items-center justify-center text-2xl transition-transform active:scale-95">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— (ä½¿ç”¨ Tailwind ç¡®ä¿æ ·å¼æ­£ç¡®) -->
    <div id="editModal" class="hidden fixed inset-0 z-[10000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl transform transition-all">
            <h3 class="text-lg font-bold mb-4 text-center text-gray-800">ğŸ“… è®°å½•æ—¥ç¨‹</h3>
            
            <label class="text-xs text-gray-400 font-bold ml-1">å†…å®¹</label>
            <textarea id="editContent" rows="3" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl mb-3 text-base focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šæ˜å¤©ä¸‹åˆä¸‰ç‚¹å¼€ä¼š"></textarea>
            
            <div class="flex gap-2 mb-5">
                <div class="flex-1">
                    <label class="text-xs text-gray-400 font-bold ml-1">æ—¥æœŸ</label>
                    <input type="date" id="editDate" class="w-full border border-gray-200 p-2.5 rounded-xl bg-gray-50 text-sm">
                </div>
                <div class="w-28">
                    <label class="text-xs text-gray-400 font-bold ml-1">æ—¶é—´</label>
                    <input type="time" id="editTime" class="w-full border border-gray-200 p-2.5 rounded-xl bg-gray-50 text-sm">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold active:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="saveEvent()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- åˆå§‹åŒ–é€»è¾‘ ---
        dayjs.locale('zh-cn');
        
        var state = {
            currentDate: dayjs(),
            events: JSON.parse(localStorage.getItem('xi_assistant_events')) || [],
            isRecording: false
        };
        
        var recognition = null;
        var SpeechClass = window.SpeechRecognition || window.webkitSpeechRecognition;

        window.onload = function() {
            renderHeader();
            renderCalendar();
            
            // ç»‘å®šå½•éŸ³æŒ‰é’®
            document.getElementById('micBtn').addEventListener('click', handleMicClick);
        };

        // --- æ ¸å¿ƒï¼šä¸‡èƒ½å¼¹çª—å‡½æ•° ---
        function openEditModal(date, content, time) {
            try {
                var modal = document.getElementById('editModal');
                // 1. å¡«å……æ•°æ®
                document.getElementById('editDate').value = date || dayjs().format('YYYY-MM-DD');
                document.getElementById('editContent').value = content || '';
                document.getElementById('editTime').value = time || dayjs().format('HH:mm');
                
                // 2. æ˜¾ç¤ºå¼¹çª— (ç§»é™¤ hidden ç±»)
                modal.classList.remove('hidden');
                
                // 3. èšç„¦è¾“å…¥æ¡† (ç¨å¾®å»¶æ—¶ï¼Œé˜²æ­¢é”®ç›˜è·³å‡ºå¡é¡¿)
                setTimeout(() => document.getElementById('editContent').focus(), 100);
            } catch(e) {
                // 4. å…œåº•æ–¹æ¡ˆï¼šå¦‚æœå¼¹çª—å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿ Prompt
                console.error(e);
                var fallbackContent = prompt("å¼¹çª—åŠ è½½å¤±è´¥ï¼Œè¯·ç›´æ¥è¾“å…¥å†…å®¹ï¼š", content || "");
                if(fallbackContent) {
                    saveEventDirectly(fallbackContent, date, time);
                }
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function forceTestModal() {
            openEditModal(dayjs().format('YYYY-MM-DD'), "æµ‹è¯•å¼¹çª—æ˜¯å¦æ­£å¸¸");
        }

        // --- æ—¥å†æ¸²æŸ“ ---
        function renderHeader() {
            document.getElementById('headerDate').innerText = dayjs().format('YYYYå¹´MæœˆDæ—¥ dddd');
            document.getElementById('currentMonthLabel').innerText = state.currentDate.format('Mæœˆ');
        }

        function renderCalendar() {
            var grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            var start = state.currentDate.startOf('month');
            var days = state.currentDate.daysInMonth();
            var offset = start.day();

            for(var i=0; i<offset; i++) grid.innerHTML += '<div class="calendar-cell bg-gray-50"></div>';

            for(var i=1; i<=days; i++) {
                var dateStr = state.currentDate.date(i).format('YYYY-MM-DD');
                var isToday = dateStr === dayjs().format('YYYY-MM-DD');
                var dayEvents = state.events.filter(e => e.date === dateStr);
                
                var cell = document.createElement('div');
                cell.className = 'calendar-cell p-1 relative ' + (isToday ? 'bg-blue-50' : 'bg-white');
                cell.innerHTML = '<div class="text-right text-xs font-bold mb-1 '+(isToday?'text-blue-600':'text-gray-700')+'">'+i+'</div>';
                
                dayEvents.forEach(e => {
                    // ç®€å•çš„æ ·å¼
                    var color = "bg-gray-100 text-gray-600";
                    if(e.content.includes("é£ç”µ")) color = "bg-cyan-100 text-cyan-800";
                    if(e.content.includes("å‚¨èƒ½")) color = "bg-green-100 text-green-800";
                    cell.innerHTML += '<div class="event-tag '+color+'">'+e.content+'</div>';
                });

                // é—­åŒ…ç»‘å®šç‚¹å‡»
                (function(d){ 
                    cell.onclick = function(){ openEditModal(d); }; 
                })(dateStr);
                
                grid.appendChild(cell);
            }
        }

        function changeMonth(n) {
            state.currentDate = state.currentDate.add(n, 'month');
            renderHeader();
            renderCalendar();
        }

        // --- ä¿å­˜é€»è¾‘ ---
        function saveEvent() {
            var content = document.getElementById('editContent').value;
            var date = document.getElementById('editDate').value;
            var time = document.getElementById('editTime').value;
            saveEventDirectly(content, date, time);
        }

        function saveEventDirectly(content, date, time) {
            if(!content) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
            
            state.events.push({ id: Date.now().toString(), content: content, date: date, time: time });
            localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
            
            closeEditModal();
            renderCalendar();
        }

        // --- è¯­éŸ³é€»è¾‘ (ç»ˆæä¿®æ­£ç‰ˆ) ---
        function handleMicClick() {
            if(!SpeechClass) return alert("æµè§ˆå™¨ä¸æ”¯æŒï¼Œè¯·æ‰‹åŠ¨è®°å½•");

            // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œç‚¹å‡»åˆ™æ˜¯åœæ­¢
            if(state.isRecording) {
                if(recognition) recognition.stop();
                return;
            }

            // å¦‚æœæ²¡åœ¨å½•éŸ³ï¼Œç‚¹å‡»åˆ™æ˜¯å¼€å§‹
            startListening();
        }

        function startListening() {
            // 1. é”€æ¯æ—§å®ä¾‹ (å…³é”®ï¼)
            if(recognition) {
                try { recognition.abort(); } catch(e){}
                recognition = null;
            }

            // 2. åˆ›å»ºæ–°å®ä¾‹
            try {
                recognition = new SpeechClass();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                
                recognition.onstart = function() {
                    state.isRecording = true;
                    updateMicStatus(true, "æ­£åœ¨å¬...");
                };
                
                recognition.onend = function() {
                    state.isRecording = false;
                    updateMicStatus(false, "");
                };
                
                recognition.onresult = function(event) {
                    var text = event.results[0][0].transcript;
                    updateMicStatus(false, "è¯†åˆ«æˆåŠŸ: " + text);
                    processVoice(text);
                };
                
                recognition.onerror = function(e) {
                    updateMicStatus(false, "é”™è¯¯: " + e.error);
                    if(e.error === 'not-allowed') alert("è¯·å…è®¸éº¦å…‹é£æƒé™");
                };

                recognition.start();

            } catch(e) {
                alert("å¯åŠ¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢: " + e.message);
            }
        }

        function updateMicStatus(isActive, text) {
            var btn = document.getElementById('micBtn');
            var tip = document.getElementById('statusTip');
            
            if(isActive) {
                btn.parentElement.classList.add('mic-active');
                btn.classList.replace('bg-blue-600', 'bg-red-500');
                tip.style.opacity = 1;
            } else {
                btn.parentElement.classList.remove('mic-active');
                btn.classList.replace('bg-red-500', 'bg-blue-600');
                if(!text) tip.style.opacity = 0;
            }
            if(text) tip.innerText = text;
        }

        function processVoice(text) {
            var date = dayjs();
            if(text.includes('æ˜å¤©')) date = date.add(1, 'day');
            if(text.includes('åå¤©')) date = date.add(2, 'day');
            if(text.includes('ä¸‹å‘¨ä¸€')) date = date.day(8);

            var content = text.replace(/æ˜å¤©|åå¤©|ä¸‹å‘¨ä¸€/g, '');
            
            // ç«‹å³æ‰“å¼€å¼¹çª—ï¼Œä¸ä½¿ç”¨ setTimeoutï¼Œé˜²æ­¢è¢«æµè§ˆå™¨ä¼‘çœ 
            openEditModal(date.format('YYYY-MM-DD'), content);
        }
    </script>
</body>
</html>