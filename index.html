<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è¥¿å§çš„å°åŠ©ç†(ç¨³å®šç‰ˆ)</title>

    <!-- 1. ä¼˜å…ˆåŠ è½½æ ·å¼ï¼Œé˜²æ­¢ç™½å± -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. å…¨å±€é”™è¯¯æ•è·ç³»ç»Ÿ (æ”¾åœ¨æœ€å‰é¢) -->
    <style>
        #error-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: auto;
            background: rgba(255, 0, 0, 0.9); color: white;
            z-index: 9999; padding: 20px; font-size: 12px;
            white-space: pre-wrap; word-break: break-all;
        }
        
        #debugConsole {
            display: block; /* å¼ºåˆ¶æ˜¾ç¤º */
            background: #1a1a1a; color: #00ff00;
            font-family: monospace; font-size: 11px;
            padding: 10px; border-top: 2px solid #333;
            height: 150px; overflow-y: scroll;
            margin-bottom: 80px; /* ç»™åº•éƒ¨æŒ‰é’®ç•™ä½ç½® */
        }

        /* åŸºç¡€æ ·å¼ */
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #F5F5F7; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .mic-wave {
            position: absolute; width: 100%; height: 100%;
            border-radius: 50%; background-color: rgba(239, 68, 68, 0.4);
            opacity: 0; z-index: -1;
        }
        .mic-active .mic-wave { animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.6); opacity: 0; } }

        .calendar-cell { min-height: 85px; border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        .calendar-cell:nth-child(7n) { border-right: none; }
        .event-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        input, textarea { -webkit-appearance: none; border-radius: 0.75rem; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>

    <script>
        // ç«‹å³æ¥ç®¡é”™è¯¯è¾“å‡º
        window.onerror = function(msg, url, line, col, error) {
            var errorBox = document.getElementById('error-overlay');
            if(errorBox) {
                errorBox.style.display = 'block';
                errorBox.innerHTML += "ğŸ”´ é”™è¯¯: " + msg + "\nä½ç½®: " + line + ":" + col + "\n\n";
            }
            // åŒæ—¶æ‰“å°åˆ°æ§åˆ¶å°
            var consoleDiv = document.getElementById('debugConsole');
            if(consoleDiv) {
                consoleDiv.innerHTML = "<div style='color:red'>> ERROR: " + msg + "</div>" + consoleDiv.innerHTML;
            }
            return false;
        };

        // æ¥ç®¡ console.log
        var oldLog = console.log;
        console.log = function(message) {
            oldLog.apply(console, arguments);
            var consoleDiv = document.getElementById('debugConsole');
            if(consoleDiv) {
                var p = document.createElement('div');
                p.innerText = "> " + message;
                consoleDiv.insertBefore(p, consoleDiv.firstChild);
            }
        };
    </script>

    <!-- 3. åŠ è½½å¤–éƒ¨åº“ (æ”¾åœ¨åé¢ï¼Œé˜²æ­¢é˜»å¡é”™è¯¯ç³»ç»Ÿ) -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-white">

    <!-- çº¢è‰²é”™è¯¯å±‚ (å¹³æ—¶éšè—ï¼ŒæŠ¥é”™æ—¶è‡ªåŠ¨å‡ºç°) -->
    <div id="error-overlay"></div>

    <!-- é¡¶éƒ¨æ  -->
    <header class="bg-[#F5F5F7] px-4 pt-12 pb-3 flex flex-col border-b border-gray-200 sticky top-0 z-20">
        <div class="flex justify-between items-end mb-2">
            <div>
                <div class="text-xs text-gray-500 font-medium mb-0.5" id="headerDate">åŠ è½½ä¸­...</div>
                <h1 class="text-2xl font-bold text-black tracking-tight flex items-center">
                    è¥¿å§çš„å°åŠ©ç† v3.2
                </h1>
            </div>
            <div class="flex bg-white rounded-lg p-1 shadow-sm">
                <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-gray-600"><i class="fas fa-chevron-left"></i></button>
                <span class="w-16 flex items-center justify-center font-bold text-sm" id="currentMonthLabel">...</span>
                <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-gray-600"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <!-- å¼ºåˆ¶æµ‹è¯•æŒ‰é’® -->
        <button onclick="forceTestModal()" class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg text-xs font-bold w-full text-center border border-blue-200">
            ğŸ›  ç‚¹æˆ‘æµ‹è¯•å¼¹çª— (è‹¥æ²¡ååº”åˆ™æ˜¯æ ·å¼é—®é¢˜)
        </button>
    </header>

    <!-- æ˜ŸæœŸå¤´ -->
    <div class="grid grid-cols-7 bg-[#F5F5F7] border-b border-gray-200 py-1">
        <div class="text-center text-xs text-gray-400">æ—¥</div>
        <div class="text-center text-xs text-gray-400">ä¸€</div>
        <div class="text-center text-xs text-gray-400">äºŒ</div>
        <div class="text-center text-xs text-gray-400">ä¸‰</div>
        <div class="text-center text-xs text-gray-400">å››</div>
        <div class="text-center text-xs text-gray-400">äº”</div>
        <div class="text-center text-xs text-gray-400">å…­</div>
    </div>

    <!-- æ—¥å†ä¸»ä½“ -->
    <div class="flex-1 overflow-y-auto bg-white relative" id="calendarContainer">
        <div class="grid grid-cols-7 border-l border-gray-100" id="calendarGrid"></div>
        
        <div class="p-4">
            <h3 class="text-xs font-bold text-gray-500 mb-2">ç³»ç»Ÿè¿è¡Œæ—¥å¿— (å®æ—¶):</h3>
            <div id="debugConsole">åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ...</div>
        </div>
        
        <div class="h-24"></div>
    </div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div class="fixed bottom-8 left-0 w-full flex flex-col items-center justify-center z-40 safe-area-bottom">
        <div class="bg-black/80 backdrop-blur-md text-white px-4 py-2 rounded-full text-xs font-bold mb-3 opacity-0 transition-opacity" id="statusTip">Ready</div>
        <div class="relative group">
            <div class="mic-wave"></div>
            <button id="micBtn" class="w-16 h-16 bg-blue-600 rounded-full text-white shadow-xl flex items-center justify-center text-2xl transition-transform active:scale-95">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— (ä½¿ç”¨æœ€ç®€å•çš„ style display æ§åˆ¶ï¼Œé˜²æ­¢ class å¤±æ•ˆ) -->
    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:999; justify-content:center; items-align:center;">
        <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);" onclick="closeEditModal()"></div>
        <div style="position:relative; width:90%; max-width:320px; background:white; padding:20px; border-radius:16px; margin-top: 30%;">
            <h3 class="text-lg font-bold mb-4 text-center">æ—¥ç¨‹è®°å½•</h3>
            <textarea id="editContent" rows="3" class="w-full bg-gray-50 border p-3 rounded-lg mb-4" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
            <div class="flex gap-2 mb-4">
                <input type="date" id="editDate" class="flex-1 border p-2 rounded-lg bg-gray-50">
                <input type="time" id="editTime" class="w-24 border p-2 rounded-lg bg-gray-50">
            </div>
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 rounded-lg font-bold">å–æ¶ˆ</button>
                <button onclick="saveEvent()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒé€»è¾‘æ”¾åœ¨æœ€åæ‰§è¡Œ
        
        // 0. å˜é‡å®šä¹‰
        var state = {
            currentDate: null,
            events: [],
            isRecording: false
        };
        var recognition = null;
        var SpeechClass = window.SpeechRecognition || window.webkitSpeechRecognition;

        // 1. åˆå§‹åŒ–å…¥å£
        try {
            console.log("è„šæœ¬å¼€å§‹æ‰§è¡Œ...");
            
            // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
            if(typeof dayjs === 'undefined') {
                throw new Error("Dayjs åº“åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜");
            }

            dayjs.locale('zh-cn');
            state.currentDate = dayjs();
            state.events = JSON.parse(localStorage.getItem('xi_assistant_events')) || [];

            console.log("åº“åŠ è½½æˆåŠŸï¼Œå¼€å§‹æ¸²æŸ“...");
            
            renderHeader();
            renderCalendar();
            // æ³¨æ„ï¼šä¸è¦åœ¨åŠ è½½æ—¶ç›´æ¥ initSpeechï¼Œè€Œæ˜¯åœ¨ç”¨æˆ·ç‚¹å‡»æ—¶æŒ‰éœ€åˆ›å»ºï¼Œè¿™æ ·æ›´ç¨³
            console.log("ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œã€‚");

        } catch (e) {
            console.log("CRITICAL ERROR: " + e.message);
            alert("å¯åŠ¨é”™è¯¯: " + e.message);
        }

        // --- åŠŸèƒ½å‡½æ•° ---

        function forceTestModal() {
            console.log("ç”¨æˆ·ç‚¹å‡»å¼ºåˆ¶æµ‹è¯•...");
            openEditModal(dayjs().format('YYYY-MM-DD'), "æµ‹è¯•å†…å®¹");
        }

        function renderHeader() {
            document.getElementById('headerDate').innerText = dayjs().format('YYYYå¹´MæœˆDæ—¥ dddd');
            document.getElementById('currentMonthLabel').innerText = state.currentDate.format('Mæœˆ');
        }

        function renderCalendar() {
            var grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            var start = state.currentDate.startOf('month');
            var days = state.currentDate.daysInMonth();
            var offset = start.day();

            for(var i=0; i<offset; i++) grid.innerHTML += '<div class="calendar-cell bg-gray-50"></div>';

            for(var i=1; i<=days; i++) {
                var dateStr = state.currentDate.date(i).format('YYYY-MM-DD');
                var isToday = dateStr === dayjs().format('YYYY-MM-DD');
                var dayEvents = state.events.filter(e => e.date === dateStr);
                
                var cell = document.createElement('div');
                cell.className = 'calendar-cell p-1 relative ' + (isToday ? 'bg-blue-50' : 'bg-white');
                cell.innerHTML = '<div class="text-right text-xs font-bold mb-1 '+(isToday?'text-blue-600':'text-gray-700')+'">'+i+'</div>';
                
                dayEvents.forEach(e => {
                    cell.innerHTML += '<div class="event-tag bg-gray-100 text-gray-600">'+e.content+'</div>';
                });
                
                // ä½¿ç”¨é—­åŒ…é˜²æ­¢å˜é‡æ±¡æŸ“
                (function(d){ cell.onclick = function(){ openEditModal(d); }; })(dateStr);
                
                grid.appendChild(cell);
            }
        }

        function changeMonth(n) {
            state.currentDate = state.currentDate.add(n, 'month');
            renderHeader();
            renderCalendar();
        }

        // --- ç®€å•çš„æ˜¾ç¤ºæ§åˆ¶ ---
        function openEditModal(date, content, time) {
            console.log("å°è¯•æ‰“å¼€å¼¹çª—: " + date);
            try {
                var modal = document.getElementById('editModal');
                modal.style.display = 'flex'; // å¼ºåˆ¶æ”¹ä¸º flex æ˜¾ç¤º
                
                document.getElementById('editDate').value = date || '';
                document.getElementById('editContent').value = content || '';
                document.getElementById('editTime').value = time || dayjs().format('HH:mm');
                console.log("å¼¹çª—æŒ‡ä»¤å·²å‘é€");
            } catch(e) {
                console.log("å¼¹çª—å¤±è´¥: " + e.message);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEvent() {
            var content = document.getElementById('editContent').value;
            var date = document.getElementById('editDate').value;
            var time = document.getElementById('editTime').value;
            
            if(!content) return alert("å†™ç‚¹å†…å®¹å§");
            
            state.events.push({ id: Date.now().toString(), content: content, date: date, time: time });
            localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
            
            closeEditModal();
            renderCalendar();
            console.log("ä¿å­˜æˆåŠŸ");
        }

        // --- è¯­éŸ³é€»è¾‘ (é‡æ„ç‰ˆï¼šæ¯æ¬¡éƒ½æ–°å»ºï¼Œé˜²æ­¢å‡æ­») ---
        
        // åˆ›å»ºä¸€ä¸ªæ–°çš„è¯­éŸ³å®ä¾‹å¹¶ç»‘å®šäº‹ä»¶
        function createRecognition() {
            if(!SpeechClass) return null;
            
            var rec = new SpeechClass();
            rec.lang = 'zh-CN';
            rec.continuous = false;
            
            rec.onstart = function() {
                state.isRecording = true;
                document.getElementById('micBtn').classList.replace('bg-blue-600', 'bg-red-500');
                document.getElementById('statusTip').style.opacity = 1;
                document.getElementById('statusTip').innerText = "æ­£åœ¨å¬...";
                console.log(">> å½•éŸ³æœºå¯åŠ¨æˆåŠŸ");
            };
            
            rec.onend = function() {
                console.log(">> å½•éŸ³ç»“æŸ (onend)");
                state.isRecording = false;
                document.getElementById('micBtn').classList.replace('bg-red-500', 'bg-blue-600');
                document.getElementById('statusTip').style.opacity = 0;
                
                // å…³é”®ä¿®æ­£ï¼šé˜²æ­¢åƒµå°¸å®ä¾‹
                if(recognition) {
                    try { recognition.abort(); } catch(e){}
                    recognition = null; // é”€æ¯å¼•ç”¨
                }
            };
            
            rec.onresult = function(event) {
                var text = event.results[0][0].transcript;
                console.log(">> è¯†åˆ«å†…å®¹: " + text);
                processVoice(text);
                // è¯†åˆ«åˆ°ç»“æœåï¼Œå¼ºåˆ¶åœæ­¢
                rec.stop();
            };
            
            rec.onerror = function(e) {
                console.log(">> å½•éŸ³æŠ¥é”™: " + e.error);
                if(e.error === 'not-allowed') alert("è¯·å…è®¸éº¦å…‹é£æƒé™");
                // æŠ¥é”™ä¹Ÿè¦é”€æ¯
                recognition = null;
                state.isRecording = false;
                document.getElementById('micBtn').classList.replace('bg-red-500', 'bg-blue-600');
            };
            
            return rec;
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('micBtn').addEventListener('click', function() {
            if(!SpeechClass) return alert("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ");
            
            // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œåˆ™åœæ­¢
            if(state.isRecording && recognition) {
                console.log("ç”¨æˆ·æ‰‹åŠ¨åœæ­¢");
                try { recognition.stop(); } catch(e){}
                return;
            }

            // å¦‚æœæ²¡åœ¨å½•éŸ³ï¼Œåˆ™å¼€å§‹
            console.log("ç”¨æˆ·ç‚¹å‡»å¼€å§‹å½•éŸ³...");
            
            // å®‰å…¨ç­–ç•¥ï¼šå…ˆå°è¯•é”€æ¯æ—§çš„ï¼ˆå¦‚æœæœ‰ï¼‰
            if(recognition) {
                try { recognition.abort(); } catch(e){}
                recognition = null;
            }

            // æ–°å»ºå®ä¾‹
            try {
                recognition = createRecognition();
                recognition.start();
            } catch(e) {
                console.log("å¯åŠ¨å¼‚å¸¸ï¼Œå°è¯•å¼ºåˆ¶é‡å¯: " + e.message);
                // å†æ¬¡å°è¯•
                setTimeout(function(){
                    if(recognition) recognition.abort();
                    recognition = createRecognition();
                    recognition.start();
                }, 200);
            }
        });

        function processVoice(text) {
            // ç®€å•çš„é€»è¾‘
            var date = dayjs();
            if(text.includes('æ˜å¤©')) date = date.add(1, 'day');
            if(text.includes('åå¤©')) date = date.add(2, 'day');
            
            var content = text.replace(/æ˜å¤©|åå¤©/g, '');
            // å»¶æ—¶ä¸€ç‚¹ç‚¹ç¡®ä¿å½•éŸ³åŠ¨ç”»ç»“æŸ
            setTimeout(function(){
                openEditModal(date.format('YYYY-MM-DD'), content);
            }, 300);
        }
    </script>
</body>
</html>