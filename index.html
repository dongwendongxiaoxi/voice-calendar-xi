<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>西姐的小助理</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
    <!-- 引入 SweetAlert2 核心样式 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: -apple-system, "SF Pro Text", BlinkMacSystemFont, sans-serif;
            background-color: #F5F5F7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 录音波纹动画 */
        .mic-wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.4);
            opacity: 0;
            z-index: -1;
        }
        .mic-active .mic-wave {
            animation: ripple 1.5s infinite;
        }
        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        /* 日历格子样式 */
        .calendar-cell {
            min-height: 85px; /* 格子变大 */
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.15s;
        }
        /* 去掉每行最后一个的右边框，保持美观 */
        .calendar-cell:nth-child(7n) { border-right: none; }
        
        .event-tag {
            font-size: 10px;
            line-height: 1.2;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* 修复 iOS 输入框阴影 */
        input, textarea {
            -webkit-appearance: none;
            border-radius: 0.75rem;
        }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-white">

    <!-- 顶部栏 -->
    <header class="bg-[#F5F5F7] px-4 pt-12 pb-3 flex justify-between items-end border-b border-gray-200 sticky top-0 z-20">
        <div onclick="debugMode()" class="cursor-pointer">
            <div class="text-xs text-gray-500 font-medium mb-0.5" id="headerDate">...</div>
            <h1 class="text-2xl font-bold text-black tracking-tight flex items-center">
                西姐的小助理
                <i class="fas fa-bolt text-yellow-500 ml-2 text-lg"></i>
            </h1>
        </div>
        <div class="flex bg-white rounded-lg p-1 shadow-sm">
            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-blue-600"><i class="fas fa-chevron-left"></i></button>
            <span class="w-16 flex items-center justify-center font-bold text-sm" id="currentMonthLabel">...</span>
            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-blue-600"><i class="fas fa-chevron-right"></i></button>
        </div>
    </header>

    <!-- 星期头 -->
    <div class="grid grid-cols-7 bg-[#F5F5F7] border-b border-gray-200 py-1">
        <div class="text-center text-xs text-gray-400 font-medium">日</div>
        <div class="text-center text-xs text-gray-400 font-medium">一</div>
        <div class="text-center text-xs text-gray-400 font-medium">二</div>
        <div class="text-center text-xs text-gray-400 font-medium">三</div>
        <div class="text-center text-xs text-gray-400 font-medium">四</div>
        <div class="text-center text-xs text-gray-400 font-medium">五</div>
        <div class="text-center text-xs text-gray-400 font-medium">六</div>
    </div>

    <!-- 大格子日历主体 -->
    <div class="flex-1 overflow-y-auto bg-white" id="calendarContainer">
        <div class="grid grid-cols-7 border-l border-gray-100" id="calendarGrid">
            <!-- 动态生成格子 -->
        </div>
        
        <!-- 版本号标识 (用于确认是否更新成功) -->
        <div class="text-center py-4 text-gray-300 text-[10px]">
            System v2.2 (Fix Popup)
        </div>
        
        <!-- 底部留白给按钮 -->
        <div class="h-24"></div>
    </div>

    <!-- 底部悬浮录音按钮 -->
    <div class="fixed bottom-8 left-0 w-full flex flex-col items-center justify-center z-50 pointer-events-none safe-area-bottom">
        <div class="bg-black/70 backdrop-blur-md text-white px-4 py-1 rounded-full text-xs font-medium mb-3 opacity-0 transition-opacity" id="statusTip">
            按住说话...
        </div>
        <div class="relative pointer-events-auto group">
            <div class="mic-wave"></div>
            <!-- 按住说话按钮 -->
            <button id="micBtn" 
                class="w-16 h-16 bg-blue-600 rounded-full text-white shadow-xl flex items-center justify-center text-2xl transition-transform active:scale-95">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
        <p class="text-[10px] text-gray-400 mt-2 font-medium">点击录音 · 再次点击停止</p>
    </div>

    <!-- 详情弹窗 -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden" aria-modal="true">
        <div class="fixed inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeDetailModal()"></div>
        <div class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl p-5 shadow-2xl transform transition-transform duration-300 safe-area-bottom">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h3 class="text-xl font-bold" id="detailDate">12月16日</h3>
                    <p class="text-xs text-gray-500" id="detailWeekday">星期一</p>
                </div>
                <button onclick="closeDetailModal()" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- 当日列表 -->
            <div id="dayEventList" class="space-y-3 mb-6 max-h-[40vh] overflow-y-auto">
                <!-- 列表项 -->
            </div>

            <!-- 手动添加按钮 -->
            <button onclick="openEditModal(state.selectedDateStr)" class="w-full py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:bg-gray-200">
                <i class="fas fa-plus mr-1"></i> 手动添加一条
            </button>
        </div>
    </div>

    <!-- 编辑/确认弹窗 -->
    <div id="editModal" class="fixed inset-0 z-[60] hidden">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeEditModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm bg-white rounded-2xl p-6 shadow-xl">
            <h3 class="text-lg font-bold mb-4">确认安排</h3>
            <textarea id="editContent" rows="3" class="w-full bg-gray-50 rounded-xl p-3 text-base mb-3 border focus:border-blue-500 outline-none" placeholder="要做什么工作？"></textarea>
            
            <div class="flex space-x-2 mb-4">
                <input type="date" id="editDate" class="flex-1 bg-gray-50 rounded-xl p-2 text-sm border">
                <input type="time" id="editTime" class="w-24 bg-gray-50 rounded-xl p-2 text-sm border">
            </div>

            <div class="flex space-x-3">
                <button onclick="closeEditModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 font-bold rounded-xl">取消</button>
                <button onclick="saveEvent()" class="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30">保存</button>
            </div>
        </div>
    </div>

    <script>
        dayjs.locale('zh-cn');

        // 状态管理
        let state = {
            currentDate: dayjs(), // 视图所在的月
            selectedDateStr: null, // 当前选中的日期字符串
            events: JSON.parse(localStorage.getItem('xi_assistant_events')) || [],
            isRecording: false
        };

        let recognition;
        let pressTimer;

        // 初始化
        window.onload = function() {
            renderHeader();
            renderCalendar();
            initSpeech();
            
            const btn = document.getElementById('micBtn');
            btn.addEventListener('click', toggleRecording);
        };

        // --- 调试功能 ---
        function debugMode() {
            // 长按标题测试弹窗
            Swal.fire({
                title: '测试成功',
                text: '弹窗功能正常运行中',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // --- 核心逻辑：大格子日历渲染 ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const startOfMonth = state.currentDate.startOf('month');
            const endOfMonth = state.currentDate.endOf('month');
            const startDay = startOfMonth.day(); // 0 is Sunday
            const daysInMonth = state.currentDate.daysInMonth();

            // 1. 填充上个月的剩余格子 (变灰)
            for (let i = 0; i < startDay; i++) {
                grid.innerHTML += `<div class="calendar-cell bg-gray-50"></div>`;
            }

            // 2. 填充本月日期
            for (let i = 1; i <= daysInMonth; i++) {
                const dateObj = state.currentDate.date(i);
                const dateStr = dateObj.format('YYYY-MM-DD');
                const isToday = dateStr === dayjs().format('YYYY-MM-DD');
                
                // 找到这一天的所有任务
                const dayEvents = state.events.filter(e => e.date === dateStr);

                // 构建格子 HTML
                const cell = document.createElement('div');
                cell.className = `calendar-cell p-1 relative cursor-pointer active:bg-gray-100 ${isToday ? 'bg-blue-50/50' : 'bg-white'}`;
                cell.onclick = () => openDetailModal(dateStr);

                // 日期数字
                let dateHtml = `<div class="text-right mb-1"><span class="text-xs font-bold ${isToday ? 'text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded-full' : 'text-gray-700'}">${i}</span></div>`;
                
                // 任务列表 (只显示前3条)
                let eventsHtml = '';
                dayEvents.slice(0, 3).forEach(e => {
                    let colorClass = "bg-gray-100 text-gray-600";
                    // 简单的关键词颜色分类
                    if(e.content.includes("风电")) colorClass = "bg-cyan-100 text-cyan-700";
                    if(e.content.includes("储能")) colorClass = "bg-green-100 text-green-700";
                    if(e.content.includes("交易")) colorClass = "bg-purple-100 text-purple-700";
                    if(e.content.includes("会")) colorClass = "bg-orange-100 text-orange-700";

                    eventsHtml += `<div class="event-tag ${colorClass}">${e.content}</div>`;
                });
                // 如果还有更多
                if(dayEvents.length > 3) {
                    eventsHtml += `<div class="text-[9px] text-gray-400 pl-1">+${dayEvents.length - 3} 更多</div>`;
                }

                cell.innerHTML = dateHtml + `<div class="flex flex-col gap-[2px]">${eventsHtml}</div>`;
                grid.appendChild(cell);
            }
        }

        // --- 交互逻辑 ---
        function renderHeader() {
            document.getElementById('headerDate').innerText = dayjs().format('YYYY年M月D日 dddd');
            document.getElementById('currentMonthLabel').innerText = state.currentDate.format('M月');
        }

        function changeMonth(offset) {
            state.currentDate = state.currentDate.add(offset, 'month');
            renderHeader();
            renderCalendar();
        }

        // --- 详情页逻辑 ---
        function openDetailModal(dateStr) {
            state.selectedDateStr = dateStr;
            const dateObj = dayjs(dateStr);
            
            document.getElementById('detailDate').innerText = dateObj.format('M月D日');
            document.getElementById('detailWeekday').innerText = dateObj.format('dddd');
            
            const list = document.getElementById('dayEventList');
            list.innerHTML = '';
            
            const dayEvents = state.events.filter(e => e.date === dateStr);
            
            if(dayEvents.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">今天是个好日子<br>暂无工作安排</div>`;
            } else {
                dayEvents.forEach(e => {
                    list.innerHTML += `
                        <div class="flex items-start p-3 bg-gray-50 rounded-xl border border-gray-100">
                            <div class="w-12 text-xs font-bold text-gray-500 pt-0.5">${e.time || '全天'}</div>
                            <div class="flex-1 text-sm font-medium text-gray-800 break-all">${e.content}</div>
                            <button onclick="deleteEvent('${e.id}')" class="text-gray-300 px-2"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function openEditModal(dateStr, content='', time='') {
            closeDetailModal(); 
            
            document.getElementById('editContent').value = content;
            document.getElementById('editDate').value = dateStr || dayjs().format('YYYY-MM-DD');
            document.getElementById('editTime').value = time || dayjs().format('HH:mm');
            
            document.getElementById('editModal').classList.remove('hidden');
            // 延迟聚焦，防止软键盘弹起卡顿
            setTimeout(() => {
                const el = document.getElementById('editContent');
                el.focus();
                el.setSelectionRange(el.value.length, el.value.length);
            }, 300);
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // --- 核心：数据存储 ---
        function saveEvent() {
            const content = document.getElementById('editContent').value.trim();
            const date = document.getElementById('editDate').value;
            const time = document.getElementById('editTime').value;

            if(!content) {
                return Swal.fire({
                    icon: 'warning',
                    title: '内容不能为空',
                    timer: 1500,
                    showConfirmButton: false
                });
            }

            state.events.push({
                id: Date.now().toString(),
                content, date, time
            });
            localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
            
            closeEditModal();
            renderCalendar(); 
            openDetailModal(date); 
            
            Swal.fire({
                icon: 'success',
                title: '已记录',
                toast: true,
                position: 'top',
                showConfirmButton: false,
                timer: 1500
            });
        }

        function deleteEvent(id) {
            Swal.fire({
                title: '删除这条记录？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    state.events = state.events.filter(e => e.id !== id);
                    localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
                    renderCalendar();
                    openDetailModal(state.selectedDateStr);
                }
            })
        }

        // --- 核心：语音识别 (v2.2 SweetAlert版) ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                return console.warn("Browser not supported");
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; 
            recognition.interimResults = false;

            recognition.onstart = () => {
                state.isRecording = true;
                const btn = document.getElementById('micBtn');
                btn.parentElement.classList.add('mic-active');
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-red-500');
                showStatus("正在聆听...");
            };

            recognition.onend = () => {
                state.isRecording = false;
                const btn = document.getElementById('micBtn');
                btn.parentElement.classList.remove('mic-active');
                btn.classList.add('bg-blue-600');
                btn.classList.remove('bg-red-500');
                showStatus(""); 
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                showStatus("识别成功");
                processVoice(text);
            };

            recognition.onerror = (event) => {
                console.error("Speech Error:", event.error);
                let title = "听不清";
                let text = "请离麦克风近一点重试";
                let icon = "question";
                
                if(event.error === 'not-allowed') {
                    title = "没有权限";
                    text = "请点击浏览器地址栏的小锁图标，允许使用麦克风。";
                    icon = "error";
                }
                else if(event.error === 'network') {
                    title = "网络错误";
                    text = "语音识别需要连接互联网。";
                    icon = "error";
                }
                else if(event.error === 'no-speech') {
                    return; // 不说话不弹窗，只是默默结束
                }
                
                Swal.fire({
                    title: title,
                    text: text,
                    icon: icon,
                    confirmButtonText: '知道了'
                });
                
                showStatus("");
            };
        }

        function toggleRecording() {
            if (!recognition) {
                return Swal.fire({
                    icon: 'error',
                    title: '不支持语音',
                    text: '您的浏览器不支持语音识别，请使用 Safari (iOS) 或 Chrome。'
                });
            }
            
            if (state.isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (e) {
                    console.error(e);
                    Swal.fire({
                        title: '启动失败',
                        text: '请刷新页面重试',
                        icon: 'error',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            }
        }

        function showStatus(text) {
            const el = document.getElementById('statusTip');
            el.innerText = text;
            el.style.opacity = text ? "1" : "0";
        }

        function processVoice(text) {
            console.log("语音内容:", text);
            let targetDate = dayjs();
            let content = text;
            
            // 日期识别
            if(text.includes('明天')) { targetDate = targetDate.add(1, 'day'); content = content.replace(/明天/g, ''); }
            else if(text.includes('后天')) { targetDate = targetDate.add(2, 'day'); content = content.replace(/后天/g, ''); }
            else if(text.includes('下周一')) { targetDate = targetDate.day(8); content = content.replace(/下周一/g, ''); }
            
            // 时间识别
            let targetTime = dayjs().format('HH:mm');
            const timeMatch = text.match(/(上午|下午|晚上)?(\d{1,2})点(\d{1,2})?/);
            if(timeMatch) {
                let h = parseInt(timeMatch[2]);
                if((timeMatch[1] === '下午' || timeMatch[1] === '晚上') && h < 12) h += 12;
                let m = timeMatch[3] ? parseInt(timeMatch[3]) : 0;
                targetTime = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                content = content.replace(timeMatch[0], '').replace('分','');
            }

            openEditModal(targetDate.format('YYYY-MM-DD'), content.trim(), targetTime);
        }
    </script>
</body>
</html>