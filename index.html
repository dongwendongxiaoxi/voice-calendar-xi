<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è¥¿å§çš„å°åŠ©ç†</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>

    <style>
        body {
            font-family: -apple-system, "SF Pro Text", BlinkMacSystemFont, sans-serif;
            background-color: #F5F5F7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .mic-wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.4);
            opacity: 0;
            z-index: -1;
        }
        .mic-active .mic-wave {
            animation: ripple 1.5s infinite;
        }
        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        .calendar-cell {
            min-height: 85px;
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.15s;
        }
        .calendar-cell:nth-child(7n) { border-right: none; }
        
        .event-tag {
            font-size: 10px;
            line-height: 1.2;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        input, textarea {
            -webkit-appearance: none;
            border-radius: 0.75rem;
        }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* æ—¥å¿—åŒºåŸŸæ ·å¼ */
        #debugConsole {
            font-family: monospace;
            font-size: 10px;
            color: #666;
            background: #eee;
            padding: 10px;
            border-top: 1px solid #ccc;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-white">

    <!-- é¡¶éƒ¨æ  -->
    <header class="bg-[#F5F5F7] px-4 pt-12 pb-3 flex justify-between items-end border-b border-gray-200 sticky top-0 z-20">
        <div onclick="toggleDebug()" class="cursor-pointer">
            <div class="text-xs text-gray-500 font-medium mb-0.5" id="headerDate">...</div>
            <h1 class="text-2xl font-bold text-black tracking-tight flex items-center">
                è¥¿å§çš„å°åŠ©ç†
                <i class="fas fa-bolt text-yellow-500 ml-2 text-lg"></i>
            </h1>
        </div>
        <div class="flex bg-white rounded-lg p-1 shadow-sm">
            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-blue-600"><i class="fas fa-chevron-left"></i></button>
            <span class="w-16 flex items-center justify-center font-bold text-sm" id="currentMonthLabel">...</span>
            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-blue-600"><i class="fas fa-chevron-right"></i></button>
        </div>
    </header>

    <!-- æ˜ŸæœŸå¤´ -->
    <div class="grid grid-cols-7 bg-[#F5F5F7] border-b border-gray-200 py-1">
        <div class="text-center text-xs text-gray-400 font-medium">æ—¥</div>
        <div class="text-center text-xs text-gray-400 font-medium">ä¸€</div>
        <div class="text-center text-xs text-gray-400 font-medium">äºŒ</div>
        <div class="text-center text-xs text-gray-400 font-medium">ä¸‰</div>
        <div class="text-center text-xs text-gray-400 font-medium">å››</div>
        <div class="text-center text-xs text-gray-400 font-medium">äº”</div>
        <div class="text-center text-xs text-gray-400 font-medium">å…­</div>
    </div>

    <!-- å¤§æ ¼å­æ—¥å†ä¸»ä½“ -->
    <div class="flex-1 overflow-y-auto bg-white relative" id="calendarContainer">
        <div class="grid grid-cols-7 border-l border-gray-100" id="calendarGrid">
            <!-- åŠ¨æ€ç”Ÿæˆæ ¼å­ -->
        </div>
        
        <!-- ç‰ˆæœ¬å·æ ‡è¯† -->
        <div class="text-center py-4 text-gray-300 text-[10px]">
            System v3.0 (Native)
        </div>
        
        <!-- åº•éƒ¨ç•™ç™½ -->
        <div class="h-24"></div>
    </div>

    <!-- å¯è§†åŒ–è°ƒè¯•æ—¥å¿— (é»˜è®¤éšè—ï¼Œç‚¹æ ‡é¢˜å¯åˆ‡æ¢) -->
    <div id="debugConsole" class="hidden">
        <div>> ç³»ç»Ÿå°±ç»ª v3.0</div>
    </div>

    <!-- åº•éƒ¨æ‚¬æµ®å½•éŸ³æŒ‰é’® -->
    <div class="fixed bottom-8 left-0 w-full flex flex-col items-center justify-center z-40 pointer-events-none safe-area-bottom">
        <div class="bg-black/80 backdrop-blur-md text-white px-4 py-2 rounded-full text-xs font-bold mb-3 opacity-0 transition-opacity shadow-lg" id="statusTip">
            å‡†å¤‡å°±ç»ª
        </div>
        <div class="relative pointer-events-auto group">
            <div class="mic-wave"></div>
            <button id="micBtn" 
                class="w-16 h-16 bg-blue-600 rounded-full text-white shadow-xl flex items-center justify-center text-2xl transition-transform active:scale-95">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
        <p class="text-[10px] text-gray-400 mt-2 font-medium">ç‚¹å‡»å½•éŸ³ Â· å†æ¬¡ç‚¹å‡»åœæ­¢</p>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— (Native Div) -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden" style="z-index: 50;">
        <div class="fixed inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeDetailModal()"></div>
        <div class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl p-5 shadow-2xl transform transition-transform duration-300 safe-area-bottom">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h3 class="text-xl font-bold" id="detailDate">...</h3>
                    <p class="text-xs text-gray-500" id="detailWeekday">...</p>
                </div>
                <button onclick="closeDetailModal()" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="dayEventList" class="space-y-3 mb-6 max-h-[40vh] overflow-y-auto"></div>

            <button onclick="openEditModal(state.selectedDateStr)" class="w-full py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:bg-gray-200">
                <i class="fas fa-plus mr-1"></i> æ‰‹åŠ¨æ·»åŠ 
            </button>
        </div>
    </div>

    <!-- ç¼–è¾‘/ç¡®è®¤å¼¹çª— (Native Div - ç»å¯¹ç½®é¡¶) -->
    <div id="editModal" class="fixed inset-0 hidden flex items-center justify-center" style="z-index: 100;">
        <!-- é®ç½© -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeEditModal()"></div>
        
        <!-- å¼¹çª—ä¸»ä½“ -->
        <div class="relative w-[90%] max-w-sm bg-white rounded-2xl p-6 shadow-2xl animate-bounce-in">
            <h3 class="text-lg font-bold mb-4 text-center">ç¡®è®¤æ—¥ç¨‹</h3>
            
            <textarea id="editContent" rows="3" class="w-full bg-gray-50 rounded-xl p-3 text-base mb-4 border border-gray-200 focus:border-blue-500 outline-none" placeholder="å†…å®¹..."></textarea>
            
            <div class="flex space-x-2 mb-6">
                <input type="date" id="editDate" class="flex-1 bg-gray-50 rounded-xl p-3 text-sm border border-gray-200">
                <input type="time" id="editTime" class="w-28 bg-gray-50 rounded-xl p-3 text-sm border border-gray-200">
            </div>

            <div class="flex space-x-3">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl">å–æ¶ˆ</button>
                <button onclick="saveEvent()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç®€å•çš„è‡ªå®šä¹‰ Alert (æ›¿ä»£ SweetAlert) -->
    <div id="customAlert" class="fixed inset-0 hidden items-center justify-center" style="z-index: 110;">
        <div class="fixed inset-0 bg-black/20" onclick="closeCustomAlert()"></div>
        <div class="relative bg-white/90 backdrop-blur-xl p-5 rounded-2xl w-64 text-center shadow-2xl border border-gray-200">
            <div id="alertIcon" class="text-3xl mb-2">âš ï¸</div>
            <h3 id="alertTitle" class="font-bold text-lg mb-1">æç¤º</h3>
            <p id="alertMsg" class="text-sm text-gray-500 mb-4">å†…å®¹</p>
            <button onclick="closeCustomAlert()" class="w-full py-2 bg-gray-100 font-bold rounded-lg text-blue-600">çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        dayjs.locale('zh-cn');

        let state = {
            currentDate: dayjs(),
            selectedDateStr: null,
            events: JSON.parse(localStorage.getItem('xi_assistant_events')) || [],
            isRecording: false
        };

        let recognition;

        // æ—¥å¿—å·¥å…·
        function log(msg) {
            console.log(msg);
            const consoleDiv = document.getElementById('debugConsole');
            const p = document.createElement('div');
            p.innerText = `> ${msg}`;
            consoleDiv.insertBefore(p, consoleDiv.firstChild);
            // è‡ªåŠ¨å±•ç¤º
            if(msg.includes('å¤±è´¥') || msg.includes('Error')) {
                consoleDiv.classList.remove('hidden');
            }
        }

        function toggleDebug() {
            document.getElementById('debugConsole').classList.toggle('hidden');
        }

        window.onload = function() {
            renderHeader();
            renderCalendar();
            initSpeech();
            document.getElementById('micBtn').addEventListener('click', toggleRecording);
            log("ç³»ç»ŸåŠ è½½å®Œæˆ");
        };

        // --- è‡ªå®šä¹‰å¼¹çª—é€»è¾‘ ---
        function showCustomAlert(title, msg, icon='âš ï¸') {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            document.getElementById('customAlert').classList.remove('hidden');
            document.getElementById('customAlert').classList.add('flex');
        }

        function closeCustomAlert() {
            document.getElementById('customAlert').classList.add('hidden');
            document.getElementById('customAlert').classList.remove('flex');
        }

        // --- æ ¸å¿ƒæ—¥å†æ¸²æŸ“ ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const startOfMonth = state.currentDate.startOf('month');
            const daysInMonth = state.currentDate.daysInMonth();
            const startDay = startOfMonth.day();

            for (let i = 0; i < startDay; i++) {
                grid.innerHTML += `<div class="calendar-cell bg-gray-50"></div>`;
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dateObj = state.currentDate.date(i);
                const dateStr = dateObj.format('YYYY-MM-DD');
                const isToday = dateStr === dayjs().format('YYYY-MM-DD');
                const dayEvents = state.events.filter(e => e.date === dateStr);

                const cell = document.createElement('div');
                cell.className = `calendar-cell p-1 relative cursor-pointer active:bg-gray-100 ${isToday ? 'bg-blue-50/50' : 'bg-white'}`;
                cell.onclick = () => openDetailModal(dateStr);

                let dateHtml = `<div class="text-right mb-1"><span class="text-xs font-bold ${isToday ? 'text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded-full' : 'text-gray-700'}">${i}</span></div>`;
                
                let eventsHtml = '';
                dayEvents.slice(0, 3).forEach(e => {
                    let colorClass = "bg-gray-100 text-gray-600";
                    if(e.content.includes("é£ç”µ")) colorClass = "bg-cyan-100 text-cyan-700";
                    if(e.content.includes("å‚¨èƒ½")) colorClass = "bg-green-100 text-green-700";
                    if(e.content.includes("äº¤æ˜“")) colorClass = "bg-purple-100 text-purple-700";
                    eventsHtml += `<div class="event-tag ${colorClass}">${e.content}</div>`;
                });
                if(dayEvents.length > 3) eventsHtml += `<div class="text-[9px] text-gray-400 pl-1">+${dayEvents.length - 3}</div>`;

                cell.innerHTML = dateHtml + `<div class="flex flex-col gap-[2px]">${eventsHtml}</div>`;
                grid.appendChild(cell);
            }
        }

        // --- äº¤äº’ä¸è§†å›¾ ---
        function renderHeader() {
            document.getElementById('headerDate').innerText = dayjs().format('YYYYå¹´MæœˆDæ—¥ dddd');
            document.getElementById('currentMonthLabel').innerText = state.currentDate.format('Mæœˆ');
        }

        function changeMonth(offset) {
            state.currentDate = state.currentDate.add(offset, 'month');
            renderHeader();
            renderCalendar();
        }

        function openDetailModal(dateStr) {
            state.selectedDateStr = dateStr;
            const dateObj = dayjs(dateStr);
            document.getElementById('detailDate').innerText = dateObj.format('MæœˆDæ—¥');
            document.getElementById('detailWeekday').innerText = dateObj.format('dddd');
            
            const list = document.getElementById('dayEventList');
            list.innerHTML = '';
            
            const dayEvents = state.events.filter(e => e.date === dateStr);
            if(dayEvents.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">æš‚æ— å®‰æ’</div>`;
            } else {
                dayEvents.forEach(e => {
                    list.innerHTML += `
                        <div class="flex items-start p-3 bg-gray-50 rounded-xl border border-gray-100">
                            <div class="w-12 text-xs font-bold text-gray-500 pt-0.5">${e.time || '--:--'}</div>
                            <div class="flex-1 text-sm font-medium text-gray-800 break-all">${e.content}</div>
                            <button onclick="deleteEvent('${e.id}')" class="text-gray-300 px-2"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                });
            }
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function openEditModal(dateStr, content='', time='') {
            log(`æ‰“å¼€ç¼–è¾‘æ¡†: ${dateStr} ${content}`);
            closeDetailModal();
            
            document.getElementById('editContent').value = content;
            document.getElementById('editDate').value = dateStr || dayjs().format('YYYY-MM-DD');
            document.getElementById('editTime').value = time || dayjs().format('HH:mm');
            
            document.getElementById('editModal').classList.remove('hidden');
            // ç®€å•çš„èšç„¦ï¼Œä¸å¼ºæ±‚å…‰æ ‡ä½ç½®ï¼Œé¿å…é”®ç›˜é—®é¢˜
            setTimeout(() => document.getElementById('editContent').focus(), 100);
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function saveEvent() {
            const content = document.getElementById('editContent').value.trim();
            const date = document.getElementById('editDate').value;
            const time = document.getElementById('editTime').value;

            if(!content) return showCustomAlert('æç¤º', 'è¯·å¡«å†™å·¥ä½œå†…å®¹', 'ğŸ“');

            state.events.push({ id: Date.now().toString(), content, date, time });
            localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
            
            closeEditModal();
            renderCalendar();
            openDetailModal(date);
        }

        function deleteEvent(id) {
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                state.events = state.events.filter(e => e.id !== id);
                localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
                renderCalendar();
                openDetailModal(state.selectedDateStr);
            }
        }

        // --- è¯­éŸ³é€»è¾‘ (Debugç‰ˆ) ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                log("Fatal: æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ API");
                return;
            }

            try {
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    state.isRecording = true;
                    updateMicUI(true);
                    showStatus("æ­£åœ¨è†å¬...");
                    log("å½•éŸ³å¼€å§‹ (onstart)");
                };

                recognition.onend = () => {
                    state.isRecording = false;
                    updateMicUI(false);
                    showStatus("");
                    log("å½•éŸ³ç»“æŸ (onend)");
                };

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    log(`è¯†åˆ«æˆåŠŸ: "${text}"`);
                    showStatus("è¯†åˆ«æˆåŠŸ");
                    processVoice(text);
                };

                recognition.onerror = (event) => {
                    log(`å½•éŸ³é”™è¯¯: ${event.error}`);
                    showCustomAlert('å‡ºé”™äº†', `è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}`, 'ğŸ¤');
                };
            } catch (e) {
                log(`Init Error: ${e.message}`);
            }
        }

        function updateMicUI(isActive) {
            const btn = document.getElementById('micBtn');
            if(isActive) {
                btn.parentElement.classList.add('mic-active');
                btn.classList.replace('bg-blue-600', 'bg-red-500');
            } else {
                btn.parentElement.classList.remove('mic-active');
                btn.classList.replace('bg-red-500', 'bg-blue-600');
            }
        }

        function toggleRecording() {
            if(!recognition) return showCustomAlert('ä¸æ”¯æŒ', 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½', 'âŒ');
            
            if(state.isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    log("è°ƒç”¨ start()...");
                } catch(e) {
                    log(`Start Error: ${e.message}`);
                    showCustomAlert('æ— æ³•å¯åŠ¨', 'è¯·åˆ·æ–°é¡µé¢é‡è¯•', 'ğŸ”„');
                }
            }
        }

        function showStatus(text) {
            const el = document.getElementById('statusTip');
            el.innerText = text;
            el.style.opacity = text ? "1" : "0";
        }

        function processVoice(text) {
            let targetDate = dayjs();
            let content = text;
            
            if(text.includes('æ˜å¤©')) { targetDate = targetDate.add(1, 'day'); content = content.replace(/æ˜å¤©/g, ''); }
            else if(text.includes('åå¤©')) { targetDate = targetDate.add(2, 'day'); content = content.replace(/åå¤©/g, ''); }
            else if(text.includes('ä¸‹å‘¨ä¸€')) { targetDate = targetDate.day(8); content = content.replace(/ä¸‹å‘¨ä¸€/g, ''); }
            
            let targetTime = dayjs().format('HH:mm');
            const timeMatch = text.match(/(ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š)?(\d{1,2})ç‚¹(\d{1,2})?/);
            if(timeMatch) {
                let h = parseInt(timeMatch[2]);
                if((timeMatch[1] === 'ä¸‹åˆ' || timeMatch[1] === 'æ™šä¸Š') && h < 12) h += 12;
                let m = timeMatch[3] ? parseInt(timeMatch[3]) : 0;
                targetTime = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                content = content.replace(timeMatch[0], '').replace('åˆ†','');
            }

            log(`è§£æç»“æœ: ${targetDate.format('MM-DD')} ${targetTime} ${content}`);
            // ç›´æ¥è°ƒç”¨æ‰“å¼€å¼¹çª—ï¼Œç¡®ä¿åœ¨å›è°ƒé“¾ä¸­æ‰§è¡Œ
            setTimeout(() => {
                openEditModal(targetDate.format('YYYY-MM-DD'), content.trim(), targetTime);
            }, 100);
        }
    </script>
</body>
</html>