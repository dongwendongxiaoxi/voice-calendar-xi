<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è¥¿å§çš„å°åŠ©ç†(å®æ—¶ç‰ˆ)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: #F5F5F7; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* å½•éŸ³æ³¢çº¹ */
        .wave-container {
            display: flex; justify-content: center; align-items: center; height: 40px; gap: 4px;
        }
        .wave-bar {
            width: 4px; height: 10px; background-color: #3B82F6; border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }
        .wave-bar:nth-child(1) { animation-delay: 0.0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave {
            0%, 100% { height: 10px; opacity: 0.5; }
            50% { height: 25px; opacity: 1; }
        }

        .calendar-cell { min-height: 85px; border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
        .calendar-cell:nth-child(7n) { border-right: none; }
        .event-tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        input, textarea { -webkit-appearance: none; border-radius: 0.5rem; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-white">

    <!-- é¡¶éƒ¨æ  -->
    <header class="bg-[#F5F5F7] px-4 pt-12 pb-3 flex flex-col border-b border-gray-200 sticky top-0 z-20">
        <div class="flex justify-between items-end mb-2">
            <div>
                <div class="text-xs text-gray-500 font-medium mb-0.5" id="headerDate">...</div>
                <h1 class="text-2xl font-bold text-black tracking-tight flex items-center">
                    è¥¿å§çš„å°åŠ©ç† <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full ml-2">v3.5</span>
                </h1>
            </div>
            <div class="flex bg-white rounded-lg p-1 shadow-sm">
                <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-gray-600"><i class="fas fa-chevron-left"></i></button>
                <span class="w-16 flex items-center justify-center font-bold text-sm" id="currentMonthLabel">...</span>
                <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-gray-600"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="window.location.reload()" class="bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-xs font-bold flex-1">
                ğŸ”„ åˆ·æ–°é‡ç½®
            </button>
            <button onclick="testModal()" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded text-xs font-bold flex-1">
                ğŸ›  æµ‹è¯•å¼¹çª—
            </button>
        </div>
    </header>

    <!-- æ˜ŸæœŸå¤´ -->
    <div class="grid grid-cols-7 bg-[#F5F5F7] border-b border-gray-200 py-1">
        <div class="text-center text-xs text-gray-400">æ—¥</div>
        <div class="text-center text-xs text-gray-400">ä¸€</div>
        <div class="text-center text-xs text-gray-400">äºŒ</div>
        <div class="text-center text-xs text-gray-400">ä¸‰</div>
        <div class="text-center text-xs text-gray-400">å››</div>
        <div class="text-center text-xs text-gray-400">äº”</div>
        <div class="text-center text-xs text-gray-400">å…­</div>
    </div>

    <!-- æ—¥å†ä¸»ä½“ -->
    <div class="flex-1 overflow-y-auto bg-white relative" id="calendarContainer">
        <div class="grid grid-cols-7 border-l border-gray-100" id="calendarGrid"></div>
        <div class="h-32"></div>
    </div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div class="fixed bottom-8 left-0 w-full flex flex-col items-center justify-center z-40 safe-area-bottom pointer-events-none">
        <div class="relative group pointer-events-auto">
            <button id="micBtn" class="w-16 h-16 bg-blue-600 rounded-full text-white shadow-xl flex items-center justify-center text-2xl transition-transform active:scale-95">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
        <p class="text-[10px] text-gray-400 mt-2 font-medium">ç‚¹å‡»å½•éŸ³</p>
    </div>

    <!-- å…¨èƒ½å¼¹çª— (ç›´æ¥æŠŠè¾“å…¥æ¡†å’Œå½•éŸ³çŠ¶æ€åšåˆ°ä¸€èµ·) -->
    <div id="editModal" class="hidden fixed inset-0 z-[10000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transition-all relative">
            
            <!-- å½•éŸ³æ—¶çš„è¦†ç›–å±‚ -->
            <div id="listeningOverlay" class="hidden absolute inset-0 bg-white/95 z-10 flex-col items-center justify-center rounded-2xl">
                <div class="wave-container mb-4">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">æ­£åœ¨è†å¬...</h3>
                <p id="liveText" class="text-sm text-gray-500 px-4 text-center min-h-[20px]">è¯·è¯´è¯...</p>
                <button onclick="stopMic()" class="mt-6 px-6 py-2 bg-red-100 text-red-600 rounded-full font-bold text-xs">
                    åœæ­¢å¹¶ç”Ÿæˆ
                </button>
            </div>

            <!-- ç¼–è¾‘ç•Œé¢ (é»˜è®¤æ˜¾ç¤º) -->
            <h3 class="text-lg font-bold mb-4 text-center text-gray-800">ğŸ“… è®°å½•æ—¥ç¨‹</h3>
            
            <textarea id="editContent" rows="3" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl mb-3 text-base focus:ring-2 focus:ring-blue-500 outline-none" placeholder="å†…å®¹ä¼šå‡ºç°åœ¨è¿™é‡Œ..."></textarea>
            
            <div class="flex gap-2 mb-5">
                <div class="flex-1">
                    <label class="text-xs text-gray-400 font-bold ml-1">æ—¥æœŸ</label>
                    <input type="date" id="editDate" class="w-full border border-gray-200 p-2.5 rounded-xl bg-gray-50 text-sm">
                </div>
                <div class="w-28">
                    <label class="text-xs text-gray-400 font-bold ml-1">æ—¶é—´</label>
                    <input type="time" id="editTime" class="w-full border border-gray-200 p-2.5 rounded-xl bg-gray-50 text-sm">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold active:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="saveEvent()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        dayjs.locale('zh-cn');
        
        var state = {
            currentDate: dayjs(),
            events: JSON.parse(localStorage.getItem('xi_assistant_events')) || [],
            isRecording: false
        };
        
        var recognition = null;
        var SpeechClass = window.SpeechRecognition || window.webkitSpeechRecognition;

        window.onload = function() {
            renderHeader();
            renderCalendar();
            // ç»‘å®šäº‹ä»¶
            document.getElementById('micBtn').addEventListener('click', startRecordingFlow);
        };

        // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šå…ˆå¼¹çª—ï¼Œå†å½•éŸ³ ---
        function startRecordingFlow() {
            if(!SpeechClass) return alert("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥");

            // 1. å…ˆæŠŠå¼¹çª—æ‰“å¼€ï¼(è¿™æ˜¯ç”¨æˆ·ç‚¹å‡»è§¦å‘çš„ï¼Œç»å¯¹åˆæ³•)
            var modal = document.getElementById('editModal');
            var overlay = document.getElementById('listeningOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden'); // æ˜¾ç¤ºæ³¢çº¹å±‚
            overlay.classList.add('flex');
            
            document.getElementById('liveText').innerText = "ç­‰å¾…å£°éŸ³...";
            
            // 2. åˆå§‹åŒ–å½•éŸ³æœº
            if(recognition) {
                try { recognition.abort(); } catch(e){}
                recognition = null;
            }

            try {
                recognition = new SpeechClass();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = true; // å¼€å¯å®æ—¶æ˜¾ç¤ºï¼

                recognition.onstart = function() {
                    state.isRecording = true;
                    document.getElementById('liveText').innerText = "æ­£åœ¨å¬...";
                };

                recognition.onresult = function(event) {
                    var text = event.results[0][0].transcript;
                    // å®æ—¶æŠŠå­—æ‰“åœ¨å±å¹•ä¸Šï¼Œè®©ç”¨æˆ·çœ‹åˆ°ååº”
                    document.getElementById('liveText').innerText = text;
                    
                    if(event.results[0].isFinal) {
                        finishRecording(text);
                    }
                };

                recognition.onerror = function(e) {
                    // å¦‚æœå‡ºé”™ï¼Œä¹Ÿè¦å…³é—­æ³¢çº¹å±‚ï¼Œä¸ç„¶å°±æ­»æœºäº†
                    if(e.error !== 'no-speech') {
                        alert("è¯†åˆ«é”™è¯¯: " + e.error);
                        stopMic(); 
                    }
                };

                recognition.onend = function() {
                    // å½•éŸ³è‡ªç„¶ç»“æŸ
                    if(state.isRecording) {
                        stopMic();
                    }
                };

                recognition.start();

            } catch(e) {
                alert("å¯åŠ¨éº¦å…‹é£å¤±è´¥: " + e.message);
                stopMic();
            }
        }

        function stopMic() {
            state.isRecording = false;
            // åœæ­¢å½•éŸ³æœº
            if(recognition) {
                try { recognition.stop(); } catch(e){}
            }
            // éšè—æ³¢çº¹å±‚ï¼Œéœ²å‡ºè¾“å…¥æ¡†
            var overlay = document.getElementById('listeningOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        function finishRecording(text) {
            stopMic();
            processVoice(text);
        }

        // --- æ•°æ®å¤„ç† ---
        function processVoice(text) {
            var date = dayjs();
            if(text.includes('æ˜å¤©')) date = date.add(1, 'day');
            if(text.includes('åå¤©')) date = date.add(2, 'day');
            if(text.includes('ä¸‹å‘¨ä¸€')) date = date.day(8);

            var content = text.replace(/æ˜å¤©|åå¤©|ä¸‹å‘¨ä¸€/g, '');
            
            // å¡«å…¥è¾“å…¥æ¡†
            document.getElementById('editDate').value = date.format('YYYY-MM-DD');
            document.getElementById('editContent').value = content;
            document.getElementById('editTime').value = dayjs().format('HH:mm');
        }

        // --- å¸¸è§„ UI ---
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            stopMic(); // å…³çª—å³åœ
        }

        function testModal() {
            // æ‰‹åŠ¨æ‰“å¼€ï¼Œä¸æ˜¾ç¤ºæ³¢çº¹å±‚
            var modal = document.getElementById('editModal');
            var overlay = document.getElementById('listeningOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            
            document.getElementById('editDate').value = dayjs().format('YYYY-MM-DD');
            document.getElementById('editTime').value = dayjs().format('HH:mm');
            document.getElementById('editContent').value = "æ‰‹åŠ¨æ·»åŠ æµ‹è¯•";
        }

        function renderHeader() {
            document.getElementById('headerDate').innerText = dayjs().format('YYYYå¹´MæœˆDæ—¥ dddd');
            document.getElementById('currentMonthLabel').innerText = state.currentDate.format('Mæœˆ');
        }

        function renderCalendar() {
            var grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            var start = state.currentDate.startOf('month');
            var days = state.currentDate.daysInMonth();
            var offset = start.day();

            for(var i=0; i<offset; i++) grid.innerHTML += '<div class="calendar-cell bg-gray-50"></div>';

            for(var i=1; i<=days; i++) {
                var dateStr = state.currentDate.date(i).format('YYYY-MM-DD');
                var isToday = dateStr === dayjs().format('YYYY-MM-DD');
                var dayEvents = state.events.filter(e => e.date === dateStr);
                
                var cell = document.createElement('div');
                cell.className = 'calendar-cell p-1 relative ' + (isToday ? 'bg-blue-50' : 'bg-white');
                cell.innerHTML = '<div class="text-right text-xs font-bold mb-1 '+(isToday?'text-blue-600':'text-gray-700')+'">'+i+'</div>';
                
                dayEvents.forEach(e => {
                    var color = "bg-gray-100 text-gray-600";
                    if(e.content.includes("é£ç”µ")) color = "bg-cyan-100 text-cyan-800";
                    if(e.content.includes("å‚¨èƒ½")) color = "bg-green-100 text-green-800";
                    cell.innerHTML += '<div class="event-tag '+color+'">'+e.content+'</div>';
                });

                (function(d){ cell.onclick = function(){ 
                    document.getElementById('editDate').value = d;
                    document.getElementById('editContent').value = '';
                    document.getElementById('editTime').value = dayjs().format('HH:mm');
                    testModal(); // å¤ç”¨æµ‹è¯•å¼¹çª—çš„é€»è¾‘æ¥æ‰“å¼€ç¼–è¾‘
                }; })(dateStr);
                
                grid.appendChild(cell);
            }
        }

        function changeMonth(n) {
            state.currentDate = state.currentDate.add(n, 'month');
            renderHeader();
            renderCalendar();
        }

        function saveEvent() {
            var content = document.getElementById('editContent').value;
            var date = document.getElementById('editDate').value;
            var time = document.getElementById('editTime').value;
            
            if(!content) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
            
            state.events.push({ id: Date.now().toString(), content: content, date: date, time: time });
            localStorage.setItem('xi_assistant_events', JSON.stringify(state.events));
            
            closeEditModal();
            renderCalendar();
        }
    </script>
</body>
</html>